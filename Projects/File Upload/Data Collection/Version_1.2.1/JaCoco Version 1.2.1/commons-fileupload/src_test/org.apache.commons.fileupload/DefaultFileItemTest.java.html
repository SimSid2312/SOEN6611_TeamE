<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>DefaultFileItemTest.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">commons-fileupload (Apr 4, 2019 4:29:55 AM)</a> &gt; <a href="../../index.html" class="el_group">commons-fileupload</a> &gt; <a href="../index.html" class="el_bundle">src/test</a> &gt; <a href="index.source.html" class="el_package">org.apache.commons.fileupload</a> &gt; <span class="el_source">DefaultFileItemTest.java</span></div><h1>DefaultFileItemTest.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.commons.fileupload;

import java.io.File;
import java.io.IOException;
import java.io.OutputStream;
import java.util.Arrays;

import junit.framework.TestCase;
import org.apache.commons.fileupload.DefaultFileItem;
import org.apache.commons.fileupload.DefaultFileItemFactory;


/**
 * Unit tests for {@link org.apache.commons.fileupload.DefaultFileItem}.
 *
 * @author &lt;a href=&quot;mailto:martinc@apache.org&quot;&gt;Martin Cooper&lt;/a&gt;
 */
public class DefaultFileItemTest extends TestCase
 {

    /**
     * Content type for regular form items.
     */
    private static final String textContentType = &quot;text/plain&quot;;

    /**
     * Content type for file uploads.
     */
    private static final String fileContentType = &quot;application/octet-stream&quot;;

    /**
     * Very low threshold for testing memory versus disk options.
     */
    private static final int threshold = 16;

    /**
     * Standard JUnit test case constructor.
     *
     * @param name The name of the test case.
     */
    public DefaultFileItemTest(String name)
    {
<span class="fc" id="L59">        super(name);</span>
<span class="fc" id="L60">    }</span>

    /**
     * Test construction of a regular text field.
     */
    public void testTextFieldConstruction()
    {
<span class="fc" id="L67">        FileItemFactory factory = createFactory(null);</span>
<span class="fc" id="L68">        String textFieldName = &quot;textField&quot;;</span>

<span class="fc" id="L70">        FileItem item = factory.createItem(</span>
<span class="fc" id="L71">                textFieldName,</span>
<span class="fc" id="L72">                textContentType,</span>
<span class="fc" id="L73">                true,</span>
<span class="fc" id="L74">                null</span>
        );
<span class="fc" id="L76">        assertNotNull(item);</span>
<span class="fc" id="L77">        assertEquals(item.getFieldName(), textFieldName);</span>
<span class="fc" id="L78">        assertEquals(item.getContentType(), textContentType);</span>
<span class="fc" id="L79">        assertTrue(item.isFormField());</span>
<span class="fc" id="L80">        assertNull(item.getName());</span>
<span class="fc" id="L81">    }</span>

    /**
     * Test construction of a file field.
     */
    public void testFileFieldConstruction()
    {
<span class="fc" id="L88">        FileItemFactory factory = createFactory(null);</span>
<span class="fc" id="L89">        String fileFieldName = &quot;fileField&quot;;</span>
<span class="fc" id="L90">        String fileName = &quot;originalFileName&quot;;</span>

<span class="fc" id="L92">        FileItem item = factory.createItem(</span>
<span class="fc" id="L93">                fileFieldName,</span>
<span class="fc" id="L94">                fileContentType,</span>
<span class="fc" id="L95">                false,</span>
<span class="fc" id="L96">                fileName</span>
        );
<span class="fc" id="L98">        assertNotNull(item);</span>
<span class="fc" id="L99">        assertEquals(item.getFieldName(), fileFieldName);</span>
<span class="fc" id="L100">        assertEquals(item.getContentType(), fileContentType);</span>
<span class="fc" id="L101">        assertFalse(item.isFormField());</span>
<span class="fc" id="L102">        assertEquals(item.getName(), fileName);</span>
<span class="fc" id="L103">    }</span>

    /**
     * Test creation of a field for which the amount of data falls below the
     * configured threshold.
     */
    public void testBelowThreshold()
    {
<span class="fc" id="L111">        FileItemFactory factory = createFactory(null);</span>
<span class="fc" id="L112">        String textFieldName = &quot;textField&quot;;</span>
<span class="fc" id="L113">        String textFieldValue = &quot;0123456789&quot;;</span>
<span class="fc" id="L114">        byte[] testFieldValueBytes = textFieldValue.getBytes();</span>

<span class="fc" id="L116">        FileItem item = factory.createItem(</span>
<span class="fc" id="L117">                textFieldName,</span>
<span class="fc" id="L118">                textContentType,</span>
<span class="fc" id="L119">                true,</span>
<span class="fc" id="L120">                null</span>
        );
<span class="fc" id="L122">        assertNotNull(item);</span>

        try
        {
<span class="fc" id="L126">            OutputStream os = item.getOutputStream();</span>
<span class="fc" id="L127">            os.write(testFieldValueBytes);</span>
<span class="fc" id="L128">            os.close();</span>
<span class="fc" id="L129">        }</span>
<span class="nc" id="L130">        catch(IOException e)</span>
        {
<span class="nc" id="L132">            fail(&quot;Unexpected IOException&quot;);</span>
        }
<span class="fc" id="L134">        assertTrue(item.isInMemory());</span>
<span class="fc" id="L135">        assertEquals(item.getSize(), testFieldValueBytes.length);</span>
<span class="fc" id="L136">        assertTrue(Arrays.equals(item.get(), testFieldValueBytes));</span>
<span class="fc" id="L137">        assertEquals(item.getString(), textFieldValue);</span>
<span class="fc" id="L138">    }</span>

    /**
     * Test creation of a field for which the amount of data falls above the
     * configured threshold, where no specific repository is configured.
     */
    public void testAboveThresholdDefaultRepository()
    {
<span class="fc" id="L146">        doTestAboveThreshold(null);</span>
<span class="fc" id="L147">    }</span>

    /**
     * Test creation of a field for which the amount of data falls above the
     * configured threshold, where a specific repository is configured.
     */
    public void testAboveThresholdSpecifiedRepository()
    {
<span class="fc" id="L155">        String tempPath = System.getProperty(&quot;java.io.tmpdir&quot;);</span>
<span class="fc" id="L156">        String tempDirName = &quot;testAboveThresholdSpecifiedRepository&quot;;</span>
<span class="fc" id="L157">        File tempDir = new File(tempPath, tempDirName);</span>
<span class="fc" id="L158">        tempDir.mkdir();</span>
<span class="fc" id="L159">        doTestAboveThreshold(tempDir);</span>
<span class="fc" id="L160">        assertTrue(tempDir.delete());</span>
<span class="fc" id="L161">    }</span>

    /**
     * Common code for cases where the amount of data is above the configured
     * threshold, but the ultimate destination of the data has not yet been
     * determined.
     *
     * @param repository The directory within which temporary files will be
     *                   created.
     */
    public void doTestAboveThreshold(File repository)
    {
<span class="fc" id="L173">        FileItemFactory factory = createFactory(repository);</span>
<span class="fc" id="L174">        String textFieldName = &quot;textField&quot;;</span>
<span class="fc" id="L175">        String textFieldValue = &quot;01234567890123456789&quot;;</span>
<span class="fc" id="L176">        byte[] testFieldValueBytes = textFieldValue.getBytes();</span>

<span class="fc" id="L178">        FileItem item = factory.createItem(</span>
<span class="fc" id="L179">                textFieldName,</span>
<span class="fc" id="L180">                textContentType,</span>
<span class="fc" id="L181">                true,</span>
<span class="fc" id="L182">                null</span>
        );
<span class="fc" id="L184">        assertNotNull(item);</span>

        try
        {
<span class="fc" id="L188">            OutputStream os = item.getOutputStream();</span>
<span class="fc" id="L189">            os.write(testFieldValueBytes);</span>
<span class="fc" id="L190">            os.close();</span>
<span class="fc" id="L191">        }</span>
<span class="nc" id="L192">        catch(IOException e)</span>
        {
<span class="nc" id="L194">            fail(&quot;Unexpected IOException&quot;);</span>
        }
<span class="fc" id="L196">        assertFalse(item.isInMemory());</span>
<span class="fc" id="L197">        assertEquals(item.getSize(), testFieldValueBytes.length);</span>
<span class="fc" id="L198">        assertTrue(Arrays.equals(item.get(), testFieldValueBytes));</span>
<span class="fc" id="L199">        assertEquals(item.getString(), textFieldValue);</span>

<span class="fc" id="L201">        assertTrue(item instanceof DefaultFileItem);</span>
<span class="fc" id="L202">        DefaultFileItem dfi = (DefaultFileItem) item;</span>
<span class="fc" id="L203">        File storeLocation = dfi.getStoreLocation();</span>
<span class="fc" id="L204">        assertNotNull(storeLocation);</span>
<span class="fc" id="L205">        assertTrue(storeLocation.exists());</span>
<span class="fc" id="L206">        assertEquals(storeLocation.length(), testFieldValueBytes.length);</span>

<span class="fc bfc" id="L208" title="All 2 branches covered.">        if (repository != null)</span>
        {
<span class="fc" id="L210">            assertEquals(storeLocation.getParentFile(), repository);</span>
        }

<span class="fc" id="L213">        item.delete();</span>
<span class="fc" id="L214">    }</span>


    /**
     * Creates a new &lt;code&gt;FileItemFactory&lt;/code&gt; and returns it, obscuring
     * from the caller the underlying implementation of this interface.
     *
     * @param repository The directory within which temporary files will be
     *                   created.
     * @return the new &lt;code&gt;FileItemFactory&lt;/code&gt; instance.
     */
    protected FileItemFactory createFactory(File repository)
    {
<span class="fc" id="L227">        return new DefaultFileItemFactory(threshold, repository);</span>
    }


    static final String CHARSET_ISO88591 = &quot;ISO-8859-1&quot;;
    static final String CHARSET_ASCII = &quot;US-ASCII&quot;;
    static final String CHARSET_UTF8 = &quot;UTF-8&quot;;
    static final String CHARSET_KOI8_R = &quot;KOI8_R&quot;;
    static final String CHARSET_WIN1251 = &quot;Cp1251&quot;;

<span class="fc" id="L237">    static final int SWISS_GERMAN_STUFF_UNICODE [] = </span>
<span class="fc" id="L238">    {</span>
<span class="fc" id="L239">        0x47, 0x72, 0xFC, 0x65, 0x7A, 0x69, 0x5F, 0x7A, 0xE4, 0x6D, 0xE4</span>
    };
    
<span class="fc" id="L242">    static final int SWISS_GERMAN_STUFF_ISO8859_1 [] = </span>
<span class="fc" id="L243">    {</span>
<span class="fc" id="L244">        0x47, 0x72, 0xFC, 0x65, 0x7A, 0x69, 0x5F, 0x7A, 0xE4, 0x6D, 0xE4</span>
    };
    
<span class="fc" id="L247">    static final int SWISS_GERMAN_STUFF_UTF8 [] = </span>
<span class="fc" id="L248">    {</span>
<span class="fc" id="L249">        0x47, 0x72, 0xC3, 0xBC, 0x65, 0x7A, 0x69, 0x5F, 0x7A, 0xC3, 0xA4,</span>
<span class="fc" id="L250">        0x6D, 0xC3, 0xA4</span>
    };

<span class="fc" id="L253">    static final int RUSSIAN_STUFF_UNICODE [] = </span>
<span class="fc" id="L254">    {</span>
<span class="fc" id="L255">        0x412, 0x441, 0x435, 0x43C, 0x5F, 0x43F, 0x440, 0x438, </span>
<span class="fc" id="L256">        0x432, 0x435, 0x442 </span>
    }; 

<span class="fc" id="L259">    static final int RUSSIAN_STUFF_UTF8 [] = </span>
<span class="fc" id="L260">    {</span>
<span class="fc" id="L261">        0xD0, 0x92, 0xD1, 0x81, 0xD0, 0xB5, 0xD0, 0xBC, 0x5F, </span>
<span class="fc" id="L262">        0xD0, 0xBF, 0xD1, 0x80, 0xD0, 0xB8, 0xD0, 0xB2, 0xD0, </span>
<span class="fc" id="L263">        0xB5, 0xD1, 0x82</span>
    };

<span class="fc" id="L266">    static final int RUSSIAN_STUFF_KOI8R [] = </span>
<span class="fc" id="L267">    {</span>
<span class="fc" id="L268">        0xF7, 0xD3, 0xC5, 0xCD, 0x5F, 0xD0, 0xD2, 0xC9, 0xD7, </span>
<span class="fc" id="L269">        0xC5, 0xD4</span>
    };

<span class="fc" id="L272">    static final int RUSSIAN_STUFF_WIN1251 [] = </span>
<span class="fc" id="L273">    {</span>
<span class="fc" id="L274">        0xC2, 0xF1, 0xE5, 0xEC, 0x5F, 0xEF, 0xF0, 0xE8, 0xE2, </span>
<span class="fc" id="L275">        0xE5, 0xF2</span>
<span class="fc" id="L276">    };</span>


    private static String constructString(int[] unicodeChars)
    {
<span class="fc" id="L281">        StringBuffer buffer = new StringBuffer();</span>
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">        if (unicodeChars != null)</span>
        {
<span class="fc bfc" id="L284" title="All 2 branches covered.">            for (int i = 0; i &lt; unicodeChars.length; i++)</span>
            {
<span class="fc" id="L286">                buffer.append((char) unicodeChars[i]);</span>
            }
        }
<span class="fc" id="L289">        return buffer.toString();</span>
    }

    /**
     * Test construction of content charset.
     */
    public void testContentCharSet() throws Exception
    {
<span class="fc" id="L297">        FileItemFactory factory = createFactory(null);</span>

<span class="fc" id="L299">        String teststr = constructString(SWISS_GERMAN_STUFF_UNICODE);</span>

<span class="fc" id="L301">        FileItem item =</span>
<span class="fc" id="L302">            factory.createItem(</span>
<span class="fc" id="L303">                &quot;doesnotmatter&quot;,</span>
<span class="fc" id="L304">                &quot;text/plain; charset=&quot; + CHARSET_ISO88591,</span>
<span class="fc" id="L305">                true,</span>
<span class="fc" id="L306">                null);</span>
<span class="fc" id="L307">        OutputStream outstream = item.getOutputStream();</span>
<span class="fc bfc" id="L308" title="All 2 branches covered.">        for (int i = 0; i &lt; SWISS_GERMAN_STUFF_ISO8859_1.length; i++)</span>
        {
<span class="fc" id="L310">            outstream.write(SWISS_GERMAN_STUFF_ISO8859_1[i]);</span>
        }
<span class="fc" id="L312">        outstream.close();</span>
<span class="fc" id="L313">        assertEquals(teststr, teststr, item.getString());</span>

<span class="fc" id="L315">        item =</span>
<span class="fc" id="L316">            factory.createItem(</span>
<span class="fc" id="L317">                &quot;doesnotmatter&quot;,</span>
<span class="fc" id="L318">                &quot;text/plain; charset=&quot; + CHARSET_UTF8,</span>
<span class="fc" id="L319">                true,</span>
<span class="fc" id="L320">                null);</span>
<span class="fc" id="L321">        outstream = item.getOutputStream();</span>
<span class="fc bfc" id="L322" title="All 2 branches covered.">        for (int i = 0; i &lt; SWISS_GERMAN_STUFF_UTF8.length; i++)</span>
        {
<span class="fc" id="L324">            outstream.write(SWISS_GERMAN_STUFF_UTF8[i]);</span>
        }
<span class="fc" id="L326">        outstream.close();</span>
<span class="fc" id="L327">        assertEquals(teststr, teststr, item.getString());</span>

<span class="fc" id="L329">        teststr = constructString(RUSSIAN_STUFF_UNICODE);</span>

<span class="fc" id="L331">        item =</span>
<span class="fc" id="L332">            factory.createItem(</span>
<span class="fc" id="L333">                &quot;doesnotmatter&quot;,</span>
<span class="fc" id="L334">                &quot;text/plain; charset=&quot; + CHARSET_KOI8_R,</span>
<span class="fc" id="L335">                true,</span>
<span class="fc" id="L336">                null);</span>
<span class="fc" id="L337">        outstream = item.getOutputStream();</span>
<span class="fc bfc" id="L338" title="All 2 branches covered.">        for (int i = 0; i &lt; RUSSIAN_STUFF_KOI8R.length; i++)</span>
        {
<span class="fc" id="L340">            outstream.write(RUSSIAN_STUFF_KOI8R[i]);</span>
        }
<span class="fc" id="L342">        outstream.close();</span>
<span class="fc" id="L343">        assertEquals(teststr, teststr, item.getString());</span>

<span class="fc" id="L345">        item =</span>
<span class="fc" id="L346">            factory.createItem(</span>
<span class="fc" id="L347">                &quot;doesnotmatter&quot;,</span>
<span class="fc" id="L348">                &quot;text/plain; charset=&quot; + CHARSET_WIN1251,</span>
<span class="fc" id="L349">                true,</span>
<span class="fc" id="L350">                null);</span>
<span class="fc" id="L351">        outstream = item.getOutputStream();</span>
<span class="fc bfc" id="L352" title="All 2 branches covered.">        for (int i = 0; i &lt; RUSSIAN_STUFF_WIN1251.length; i++)</span>
        {
<span class="fc" id="L354">            outstream.write(RUSSIAN_STUFF_WIN1251[i]);</span>
        }
<span class="fc" id="L356">        outstream.close();</span>
<span class="fc" id="L357">        assertEquals(teststr, teststr, item.getString());</span>

<span class="fc" id="L359">        item =</span>
<span class="fc" id="L360">            factory.createItem(</span>
<span class="fc" id="L361">                &quot;doesnotmatter&quot;,</span>
<span class="fc" id="L362">                &quot;text/plain; charset=&quot; + CHARSET_UTF8,</span>
<span class="fc" id="L363">                true,</span>
<span class="fc" id="L364">                null);</span>
<span class="fc" id="L365">        outstream = item.getOutputStream();</span>
<span class="fc bfc" id="L366" title="All 2 branches covered.">        for (int i = 0; i &lt; RUSSIAN_STUFF_UTF8.length; i++)</span>
        {
<span class="fc" id="L368">            outstream.write(RUSSIAN_STUFF_UTF8[i]);</span>
        }
<span class="fc" id="L370">        outstream.close();</span>
<span class="fc" id="L371">        assertEquals(teststr, teststr, item.getString());</span>
<span class="fc" id="L372">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span>commons-fileupload (Apr 4, 2019 4:29:55 AM)</div></body></html>